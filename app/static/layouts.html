<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Layout Review</title>
    <style>
      :root {
        --bg: #f3f1eb;
        --surface: #fffdf7;
        --ink: #1e1f1c;
        --muted: #63635f;
        --accent: #0b7a75;
        --danger: #a52222;
        --border: #e0dccf;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 100% 0, #d6ebe7 0, transparent 30%),
          radial-gradient(circle at 0 100%, #f7e3cf 0, transparent 32%),
          var(--bg);
      }

      main {
        max-width: 1360px;
        width: 100%;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      h1 {
        margin: 0;
        font-size: 26px;
      }

      .subline {
        color: var(--muted);
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .detect-controls {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }

      .detect-controls label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 13px;
        color: var(--muted);
      }

      .detect-controls input {
        width: 84px;
      }

      button,
      a.button-link {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        border-radius: 10px;
        padding: 8px 12px;
        font-weight: 600;
        cursor: pointer;
        text-decoration: none;
      }

      button.secondary {
        background: #fff;
        color: var(--accent);
      }

      a.button-link.secondary {
        background: #fff;
        color: var(--accent);
      }

      button.danger {
        border-color: var(--danger);
        background: var(--danger);
      }

      .grid {
        margin-top: 16px;
        display: grid;
        grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
        gap: 16px;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
      }

      .image-wrap {
        position: relative;
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        overflow: hidden;
        background: #f7f5ef;
      }

      #page-image {
        display: block;
        width: 100%;
        height: auto;
      }

      #overlay {
        position: absolute;
        inset: 0;
      }

      .box {
        position: absolute;
        border: 2px solid #0b7a75;
        background: rgba(11, 122, 117, 0.12);
        border-radius: 4px;
      }

      .box-label {
        position: absolute;
        top: -20px;
        left: 0;
        font-size: 12px;
        background: rgba(255, 253, 247, 0.92);
        color: #1e1f1c;
        border: 1px solid #cfc8b7;
        border-radius: 6px;
        padding: 2px 6px;
        white-space: nowrap;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        border-bottom: 1px solid var(--border);
        text-align: left;
        padding: 8px 6px;
        vertical-align: top;
      }

      th {
        font-size: 13px;
        color: var(--muted);
      }

      input {
        width: 100%;
        padding: 6px;
        border: 1px solid var(--border);
        border-radius: 8px;
      }

      select {
        width: 100%;
        padding: 6px;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: #fff;
      }

      .status-line {
        margin-top: 8px;
        color: var(--muted);
      }

      .legend {
        margin-bottom: 12px;
        padding: 10px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
      }

      .legend-title {
        margin: 0 0 8px;
        font-size: 13px;
        color: var(--muted);
        font-weight: 700;
      }

      .legend-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px 10px;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 7px;
        font-size: 12px;
      }

      .legend-swatch {
        width: 14px;
        height: 14px;
        border-radius: 3px;
        border: 1px solid rgba(0, 0, 0, 0.25);
        flex: 0 0 auto;
      }

      .legend-note {
        margin: 8px 0 0;
        color: var(--muted);
        font-size: 11px;
      }

      .error {
        color: var(--danger);
      }

      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="header">
        <div>
          <h1>Layout Review</h1>
          <div id="page-meta" class="subline"></div>
        </div>
        <div class="actions">
          <a class="button-link secondary" href="/">Back to Dashboard</a>
          <div class="detect-controls">
            <label>
              Conf
              <input id="detect-conf" type="number" min="0" max="1" step="0.01" value="0.25" />
            </label>
            <label>
              IoU
              <input id="detect-iou" type="number" min="0" max="1" step="0.01" value="0.45" />
            </label>
          </div>
          <button id="detect-btn" type="button">Redetect Layouts</button>
          <button id="add-btn" class="secondary" type="button">Add Box</button>
          <button id="review-btn" type="button">Mark Reviewed</button>
          <button id="review-next-btn" class="secondary" type="button" disabled>Review</button>
        </div>
      </section>

      <section class="grid">
        <article class="panel">
          <div class="image-wrap">
            <img id="page-image" alt="Page for layout review" />
            <div id="overlay"></div>
          </div>
          <div id="status-line" class="status-line"></div>
        </article>

        <article class="panel">
          <h2>Layouts</h2>
          <div id="legend" class="legend">
            <p class="legend-title">Class Colors</p>
            <div id="legend-grid" class="legend-grid"></div>
            <p class="legend-note">Unknown classes are assigned deterministic fallback colors.</p>
          </div>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Class</th>
                <th>Order</th>
                <th>BBox (0-1)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="layouts-body"></tbody>
          </table>
        </article>
      </section>
    </main>

    <script type="module">
      const params = new URLSearchParams(window.location.search);
      const pageId = Number(params.get("page_id"));
      const STORAGE_KEYS = {
        detectConf: "layout.detect_conf",
        detectIou: "layout.detect_iou",
      };

      function readStorage(key) {
        try {
          return window.localStorage.getItem(key);
        } catch {
          return null;
        }
      }

      function writeStorage(key, value) {
        try {
          window.localStorage.setItem(key, value);
        } catch {
          // Ignore storage errors (private mode / quota / disabled storage).
        }
      }

      const pageMeta = document.getElementById("page-meta");
      const pageImage = document.getElementById("page-image");
      const overlay = document.getElementById("overlay");
      const statusLine = document.getElementById("status-line");
      const layoutsBody = document.getElementById("layouts-body");
      const legendGrid = document.getElementById("legend-grid");

      const detectBtn = document.getElementById("detect-btn");
      const addBtn = document.getElementById("add-btn");
      const reviewBtn = document.getElementById("review-btn");
      const reviewNextBtn = document.getElementById("review-next-btn");
      const detectConfInput = document.getElementById("detect-conf");
      const detectIouInput = document.getElementById("detect-iou");

      const state = {
        page: null,
        layouts: [],
      };

      function applyStoredDetectThresholds() {
        const storedConf = readStorage(STORAGE_KEYS.detectConf);
        const storedIou = readStorage(STORAGE_KEYS.detectIou);

        if (storedConf !== null) {
          const parsedConf = Number(storedConf);
          if (!Number.isNaN(parsedConf) && parsedConf >= 0 && parsedConf <= 1) {
            detectConfInput.value = storedConf;
          }
        }
        if (storedIou !== null) {
          const parsedIou = Number(storedIou);
          if (!Number.isNaN(parsedIou) && parsedIou >= 0 && parsedIou <= 1) {
            detectIouInput.value = storedIou;
          }
        }
      }

      const CLASS_COLORS = {
        title: "#8f4b63",
        section_header: "#355fa8",
        text: "#4f5d69",
        list_item: "#2f6f5f",
        table: "#6f7d2f",
        picture: "#8a6831",
        caption: "#496f98",
        footnote: "#7a6030",
        formula: "#7b5a95",
        page_header: "#3f6e69",
        page_footer: "#8b5949",
      };

      const KNOWN_LAYOUT_CLASSES = [
        "title",
        "section_header",
        "text",
        "list_item",
        "table",
        "picture",
        "caption",
        "footnote",
        "formula",
        "page_header",
        "page_footer",
      ];

      const FALLBACK_COLORS = ["#4e6f8f", "#7c5f90", "#3f7b69", "#8d6a3b", "#82605b", "#537987", "#6e6b3f"];

      function hashString(value) {
        let hash = 0;
        for (let i = 0; i < value.length; i += 1) {
          hash = (hash << 5) - hash + value.charCodeAt(i);
          hash |= 0;
        }
        return Math.abs(hash);
      }

      function colorForClass(className) {
        const normalized = String(className || "")
          .trim()
          .toLowerCase()
          .replace(/[-/\s]+/g, "_");
        if (CLASS_COLORS[normalized]) {
          return CLASS_COLORS[normalized];
        }
        return FALLBACK_COLORS[hashString(normalized) % FALLBACK_COLORS.length];
      }

      function hexToRgba(hex, alpha) {
        const clean = hex.replace("#", "");
        const r = Number.parseInt(clean.slice(0, 2), 16);
        const g = Number.parseInt(clean.slice(2, 4), 16);
        const b = Number.parseInt(clean.slice(4, 6), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
      }

      function setStatus(message, { isError = false } = {}) {
        statusLine.textContent = message;
        statusLine.classList.toggle("error", isError);
      }

      async function fetchJson(url, options) {
        const response = await fetch(url, options);
        const payload = await response.json().catch(() => ({}));
        if (!response.ok) {
          const detail = payload && payload.detail ? payload.detail : `Request failed: ${response.status}`;
          throw new Error(detail);
        }
        return payload;
      }

      function toFixed(value) {
        return Number(value).toFixed(4);
      }

      function boxStyle(layout) {
        const { x1, y1, x2, y2 } = layout.bbox;
        return {
          left: `${x1 * 100}%`,
          top: `${y1 * 100}%`,
          width: `${(x2 - x1) * 100}%`,
          height: `${(y2 - y1) * 100}%`,
        };
      }

      function renderOverlay() {
        overlay.innerHTML = "";
        for (const layout of state.layouts) {
          const color = colorForClass(layout.class_name);
          const box = document.createElement("div");
          box.className = "box";
          const style = boxStyle(layout);
          box.style.left = style.left;
          box.style.top = style.top;
          box.style.width = style.width;
          box.style.height = style.height;
          box.style.borderColor = color;
          box.style.background = hexToRgba(color, 0.16);

          const label = document.createElement("div");
          label.className = "box-label";
          label.style.color = color;
          label.style.borderColor = hexToRgba(color, 0.62);
          label.textContent = `${layout.reading_order}. ${layout.class_name}`;
          box.appendChild(label);
          overlay.appendChild(box);
        }
      }

      function formatClassLabel(className) {
        return String(className)
          .replace(/_/g, " ")
          .replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function normalizeClassName(className) {
        return String(className || "")
          .trim()
          .toLowerCase()
          .replace(/[-/\s]+/g, "_");
      }

      function buildClassSelect(initialClass) {
        const select = document.createElement("select");
        const normalizedInitial = normalizeClassName(initialClass);
        const classes = [...KNOWN_LAYOUT_CLASSES];
        if (normalizedInitial && !classes.includes(normalizedInitial)) {
          classes.unshift(normalizedInitial);
        }

        for (const className of classes) {
          const option = document.createElement("option");
          option.value = className;
          option.textContent = formatClassLabel(className);
          select.appendChild(option);
        }

        select.value = normalizedInitial || "text";
        return select;
      }

      function applyClassColorToSelect(select, className) {
        const color = colorForClass(className);
        select.style.borderColor = hexToRgba(color, 0.55);
        select.style.color = color;
      }

      function renderLegend() {
        const seen = new Set(Object.keys(CLASS_COLORS));
        for (const layout of state.layouts) {
          const normalized = String(layout.class_name || "")
            .trim()
            .toLowerCase()
            .replace(/[-/\s]+/g, "_");
          if (normalized) {
            seen.add(normalized);
          }
        }

        const classes = Array.from(seen).sort();
        legendGrid.innerHTML = "";

        for (const className of classes) {
          const color = colorForClass(className);
          const item = document.createElement("div");
          item.className = "legend-item";

          const swatch = document.createElement("span");
          swatch.className = "legend-swatch";
          swatch.style.background = hexToRgba(color, 0.22);
          swatch.style.borderColor = hexToRgba(color, 0.7);

          const label = document.createElement("span");
          label.textContent = formatClassLabel(className);
          label.style.color = color;

          item.appendChild(swatch);
          item.appendChild(label);
          legendGrid.appendChild(item);
        }
      }

      function layoutRow(layout) {
        const tr = document.createElement("tr");

        const idTd = document.createElement("td");
        idTd.textContent = String(layout.id);
        tr.appendChild(idTd);

        const classTd = document.createElement("td");
        const classInput = buildClassSelect(layout.class_name);
        applyClassColorToSelect(classInput, layout.class_name);
        classInput.addEventListener("change", () => {
          applyClassColorToSelect(classInput, classInput.value);
        });
        classTd.appendChild(classInput);
        tr.appendChild(classTd);

        const orderTd = document.createElement("td");
        const orderInput = document.createElement("input");
        orderInput.type = "number";
        orderInput.min = "1";
        orderInput.step = "1";
        orderInput.value = String(layout.reading_order);
        orderTd.appendChild(orderInput);
        tr.appendChild(orderTd);

        const bboxTd = document.createElement("td");
        const bboxFields = ["x1", "y1", "x2", "y2"].map((key) => {
          const input = document.createElement("input");
          input.type = "number";
          input.min = "0";
          input.max = "1";
          input.step = "0.0001";
          input.value = toFixed(layout.bbox[key]);
          return [key, input];
        });
        for (const [, input] of bboxFields) {
          bboxTd.appendChild(input);
        }
        tr.appendChild(bboxTd);

        const actionsTd = document.createElement("td");
        const saveBtn = document.createElement("button");
        saveBtn.className = "secondary";
        saveBtn.type = "button";
        saveBtn.textContent = "Save";
        saveBtn.addEventListener("click", async () => {
          try {
            await fetchJson(`/api/layouts/${layout.id}`, {
              method: "PATCH",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                class_name: classInput.value,
                reading_order: Number(orderInput.value),
                bbox: {
                  x1: Number(bboxFields[0][1].value),
                  y1: Number(bboxFields[1][1].value),
                  x2: Number(bboxFields[2][1].value),
                  y2: Number(bboxFields[3][1].value),
                },
              }),
            });
            setStatus(`Layout ${layout.id} updated.`);
            await loadLayouts();
          } catch (error) {
            setStatus(`Update failed: ${error.message}`, { isError: true });
          }
        });
        actionsTd.appendChild(saveBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "danger";
        deleteBtn.type = "button";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", async () => {
          try {
            await fetchJson(`/api/layouts/${layout.id}`, { method: "DELETE" });
            setStatus(`Layout ${layout.id} deleted.`);
            await loadLayouts();
          } catch (error) {
            setStatus(`Delete failed: ${error.message}`, { isError: true });
          }
        });
        actionsTd.appendChild(deleteBtn);

        tr.appendChild(actionsTd);
        return tr;
      }

      function renderLayouts() {
        layoutsBody.innerHTML = "";
        for (const layout of state.layouts) {
          layoutsBody.appendChild(layoutRow(layout));
        }
        renderOverlay();
        renderLegend();
      }

      async function loadPage() {
        const payload = await fetchJson(`/api/pages/${pageId}`);
        state.page = payload.page;
        pageMeta.textContent = `Page #${state.page.id} | ${state.page.rel_path} | status: ${state.page.status}`;
        pageImage.src = payload.image_url;
      }

      async function loadLayouts() {
        const payload = await fetchJson(`/api/pages/${pageId}/layouts`);
        state.layouts = payload.layouts;
        renderLayouts();
      }

      async function refreshNextReviewButton() {
        try {
          const payload = await fetchJson(`/api/pages/${pageId}/layout-review-next`);
          if (payload.has_next && Number.isInteger(payload.next_page_id) && payload.next_page_id > 0) {
            reviewNextBtn.disabled = false;
            reviewNextBtn.dataset.nextPageId = String(payload.next_page_id);
            reviewNextBtn.title = `Open next page: ${payload.next_page_rel_path}`;
          } else {
            reviewNextBtn.disabled = true;
            reviewNextBtn.dataset.nextPageId = "";
            reviewNextBtn.title = "No pages are waiting for layout review.";
          }
        } catch {
          reviewNextBtn.disabled = true;
          reviewNextBtn.dataset.nextPageId = "";
          reviewNextBtn.title = "Failed to load next page for review.";
        }
      }

      async function detectLayouts() {
        detectBtn.disabled = true;
        try {
          const confidence = Number(detectConfInput.value);
          const iou = Number(detectIouInput.value);
          if (Number.isNaN(confidence) || confidence < 0 || confidence > 1) {
            throw new Error("Confidence must be between 0 and 1.");
          }
          if (Number.isNaN(iou) || iou < 0 || iou > 1) {
            throw new Error("IoU must be between 0 and 1.");
          }

          const payload = await fetchJson(`/api/pages/${pageId}/layouts/detect`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              replace_existing: true,
              confidence_threshold: confidence,
              iou_threshold: iou,
            }),
          });
          setStatus(
            `Redetect finished. Created ${payload.created} layouts. Conf=${payload.thresholds.confidence_threshold}, IoU=${payload.thresholds.iou_threshold}.`,
          );
          await loadPage();
          await loadLayouts();
          await refreshNextReviewButton();
        } catch (error) {
          setStatus(`Redetect failed: ${error.message}`, { isError: true });
        } finally {
          detectBtn.disabled = false;
        }
      }

      async function addLayout() {
        addBtn.disabled = true;
        try {
          await fetchJson(`/api/pages/${pageId}/layouts`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              class_name: "text",
              reading_order: null,
              bbox: { x1: 0.1, y1: 0.1, x2: 0.9, y2: 0.2 },
            }),
          });
          setStatus("Manual layout added.");
          await loadPage();
          await loadLayouts();
          await refreshNextReviewButton();
        } catch (error) {
          setStatus(`Add failed: ${error.message}`, { isError: true });
        } finally {
          addBtn.disabled = false;
        }
      }

      async function markReviewed() {
        reviewBtn.disabled = true;
        try {
          const payload = await fetchJson(`/api/pages/${pageId}/layouts/review-complete`, {
            method: "POST",
          });
          setStatus(`Page marked reviewed with ${payload.layout_count} layouts.`);
          await loadPage();
          await loadLayouts();
          await refreshNextReviewButton();
        } catch (error) {
          setStatus(`Mark reviewed failed: ${error.message}`, { isError: true });
        } finally {
          reviewBtn.disabled = false;
        }
      }

      detectBtn.addEventListener("click", detectLayouts);
      addBtn.addEventListener("click", addLayout);
      reviewBtn.addEventListener("click", markReviewed);
      reviewNextBtn.addEventListener("click", () => {
        const nextPageId = Number.parseInt(reviewNextBtn.dataset.nextPageId || "", 10);
        if (Number.isInteger(nextPageId) && nextPageId > 0) {
          window.location.href = `/static/layouts.html?page_id=${nextPageId}`;
        }
      });
      detectConfInput.addEventListener("change", () => {
        writeStorage(STORAGE_KEYS.detectConf, detectConfInput.value);
      });
      detectIouInput.addEventListener("change", () => {
        writeStorage(STORAGE_KEYS.detectIou, detectIouInput.value);
      });

      async function init() {
        if (!Number.isInteger(pageId) || pageId <= 0) {
          setStatus("Missing or invalid page_id query parameter.", { isError: true });
          return;
        }
        try {
          await loadPage();
          await loadLayouts();
          await refreshNextReviewButton();
          setStatus("Ready.");
        } catch (error) {
          setStatus(`Load failed: ${error.message}`, { isError: true });
        }
      }

      applyStoredDetectThresholds();
      init();
    </script>
  </body>
</html>
