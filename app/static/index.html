<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <style>
      :root {
        --bg: #f3f1eb;
        --surface: #fffdf7;
        --ink: #1e1f1c;
        --muted: #63635f;
        --accent: #0b7a75;
        --danger: #a52222;
        --border: #e0dccf;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 100% 0, #d6ebe7 0, transparent 30%),
          radial-gradient(circle at 0 100%, #f7e3cf 0, transparent 32%),
          var(--bg);
      }

      main {
        max-width: 1180px;
        width: 100%;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 16px;
      }

      h1 {
        margin: 0;
        font-size: 28px;
      }

      .subline {
        color: var(--muted);
        margin-top: 6px;
      }

      .header-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .pipeline-actions {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .pipeline-separator {
        color: var(--muted);
        font-weight: 700;
        font-size: 16px;
        line-height: 1;
      }

      button {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px 16px;
        cursor: pointer;
      }

      button.secondary {
        background: #fff;
        color: var(--accent);
      }

      button.danger-btn {
        border-color: var(--danger);
        background: var(--danger);
      }

      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
      }

      #last-scan {
        color: var(--muted);
        font-size: 13px;
        margin: 0 0 12px;
      }

      .danger {
        border-color: #efcece;
        background: #fff5f5;
      }

      .danger strong {
        color: var(--danger);
      }

      .panel-title {
        margin: 0 0 8px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      th {
        font-size: 13px;
        color: var(--muted);
      }

      .status {
        border-radius: 999px;
        display: inline-block;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 700;
        background: #ecf0ef;
      }

      .status.missing {
        color: var(--danger);
        background: #fcebec;
      }

      .empty-row {
        color: var(--muted);
      }

      .activity-headline {
        margin: 0;
        font-weight: 700;
        text-align: left;
        flex: 1;
      }

      .activity-meta {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .panel-toggle {
        width: 100%;
        border: 0;
        background: transparent;
        color: inherit;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .panel-toggle-icon {
        width: 22px;
        height: 22px;
        border: 1px solid var(--border);
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-weight: 700;
      }

      .activity-body {
        margin-top: 10px;
      }

      .activity-list {
        margin: 12px 0 0;
        padding-left: 0;
        list-style: none;
      }

      .activity-list li {
        margin: 4px 0;
      }

      .activity-event-ts {
        color: var(--muted);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(18, 23, 25, 0.52);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 20;
      }

      .modal-backdrop[hidden] {
        display: none;
      }

      .modal-card {
        width: min(460px, 100%);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
      }

      .modal-card h2 {
        margin: 0 0 8px;
      }

      .modal-card p {
        margin: 0 0 12px;
        color: var(--muted);
      }

      .modal-card code {
        background: #ece8df;
        border-radius: 6px;
        padding: 1px 6px;
      }

      .modal-input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        font-size: 14px;
      }

      .modal-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      @media (max-width: 980px) {
        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        table,
        thead,
        tbody,
        tr,
        th,
        td {
          display: block;
        }

        thead {
          display: none;
        }

        tr {
          border-bottom: 1px solid var(--border);
          padding: 10px 0;
        }

        td {
          border: 0;
          padding: 4px 0;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <section class="header">
        <div>
          <h1>Dashboard</h1>
          <div class="header-actions">
            <div class="pipeline-actions" role="group" aria-label="Pipeline actions">
              <button id="scan-btn" type="button">Scan</button>
              <span class="pipeline-separator" aria-hidden="true">&gt;</span>
              <button id="review-layouts-btn" class="secondary" type="button" disabled>Review layouts</button>
            </div>
          </div>
        </div>
        <button id="wipe-btn" class="danger-btn" type="button">Wipe DB State</button>
      </section>
      <p id="last-scan"></p>

      <section class="panel">
        <button id="pipeline-toggle" class="panel-toggle" type="button" aria-expanded="false">
          <p id="pipeline-headline" class="activity-headline">Pipeline worker idle</p>
          <span id="pipeline-toggle-icon" class="panel-toggle-icon">+</span>
        </button>
        <div id="pipeline-body" class="activity-body" hidden>
          <p id="pipeline-queue" class="activity-meta"></p>
          <ul id="pipeline-events" class="activity-list"></ul>
        </div>
      </section>

      <section id="duplicate-panel" class="panel danger" hidden>
        <strong>Duplicate files were skipped.</strong>
        <p>
          This warning stays visible on each app start until duplicate files are removed from
          the input folder.
        </p>
        <div id="duplicate-list"></div>
      </section>

      <section class="panel">
        <h2 class="panel-title">All Indexed Images</h2>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Relative Path</th>
              <th>Status</th>
              <th>Last Seen</th>
              <th>Layout Review</th>
            </tr>
          </thead>
          <tbody id="pages-body"></tbody>
        </table>
      </section>
    </main>

    <div id="wipe-modal" class="modal-backdrop" hidden>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="wipe-modal-title">
        <h2 id="wipe-modal-title">Confirm DB Wipe</h2>
        <p>Type <code>wipe</code> to delete all indexed pages, layouts, and duplicate state.</p>
        <input
          id="wipe-confirm-input"
          class="modal-input"
          type="text"
          placeholder="Type wipe"
          autocomplete="off"
          spellcheck="false"
        />
        <div class="modal-actions">
          <button id="wipe-cancel-btn" class="secondary" type="button">Cancel</button>
          <button id="wipe-confirm-btn" class="danger-btn" type="button" disabled>Wipe DB State</button>
        </div>
      </div>
    </div>

    <script type="module">
      const STORAGE_KEYS = {
        pipelinePanelExpanded: "dashboard.pipeline_panel_expanded",
      };

      function readStorage(key) {
        try {
          return window.localStorage.getItem(key);
        } catch {
          return null;
        }
      }

      function writeStorage(key, value) {
        try {
          window.localStorage.setItem(key, value);
        } catch {
          // Ignore storage errors (private mode / quota / disabled storage).
        }
      }

      function readStorageBool(key, defaultValue) {
        const raw = readStorage(key);
        if (raw === null) {
          return defaultValue;
        }
        return raw === "1";
      }

      const scanBtn = document.getElementById("scan-btn");
      const reviewLayoutsBtn = document.getElementById("review-layouts-btn");
      const wipeBtn = document.getElementById("wipe-btn");
      const wipeModal = document.getElementById("wipe-modal");
      const wipeConfirmInput = document.getElementById("wipe-confirm-input");
      const wipeCancelBtn = document.getElementById("wipe-cancel-btn");
      const wipeConfirmBtn = document.getElementById("wipe-confirm-btn");

      const pagesBody = document.getElementById("pages-body");
      const duplicatePanel = document.getElementById("duplicate-panel");
      const duplicateList = document.getElementById("duplicate-list");
      const lastScan = document.getElementById("last-scan");
      const pipelineToggle = document.getElementById("pipeline-toggle");
      const pipelineBody = document.getElementById("pipeline-body");
      const pipelineHeadline = document.getElementById("pipeline-headline");
      const pipelineToggleIcon = document.getElementById("pipeline-toggle-icon");
      const pipelineQueue = document.getElementById("pipeline-queue");
      const pipelineEvents = document.getElementById("pipeline-events");

      let nextReviewPageId = null;
      let pipelinePanelExpanded = false;
      let activityStream = null;
      let streamReconnectTimer = null;
      let activityPollingTimer = null;
      const DATE_LOCALE = "en-GB";
      const DATE_TIME_FORMAT = {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      };
      const TIME_FORMAT = {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
        hour12: false,
      };

      async function fetchJson(url, options) {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }
        return response.json();
      }

      function formatDateTime(value) {
        const date = new Date(value);
        return date.toLocaleString(DATE_LOCALE, DATE_TIME_FORMAT);
      }

      function formatTime(value) {
        const date = new Date(value);
        return date.toLocaleTimeString(DATE_LOCALE, TIME_FORMAT);
      }

      function setPipelinePanelExpanded(expanded) {
        pipelinePanelExpanded = expanded;
        pipelineToggle.setAttribute("aria-expanded", expanded ? "true" : "false");
        pipelineBody.hidden = !expanded;
        pipelineToggleIcon.textContent = expanded ? "-" : "+";
        writeStorage(STORAGE_KEYS.pipelinePanelExpanded, expanded ? "1" : "0");
      }

      function renderPages(pages) {
        pagesBody.innerHTML = "";
        if (pages.length === 0) {
          const tr = document.createElement("tr");
          tr.innerHTML = '<td class="empty-row" colspan="5">No indexed documents found yet.</td>';
          pagesBody.appendChild(tr);
          return;
        }

        for (const page of pages) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${page.id}</td>
            <td>${page.rel_path}</td>
            <td>
              <span class="status ${page.is_missing ? "missing" : ""}">
                ${page.is_missing ? "missing" : page.status}
              </span>
            </td>
            <td>${formatDateTime(page.last_seen_at)}</td>
            <td>
              ${
                page.is_missing
                  ? '<span class="subline">Unavailable</span>'
                  : `<a href="/static/layouts.html?page_id=${page.id}">Open</a>`
              }
            </td>
          `;
          pagesBody.appendChild(tr);
        }
      }

      function renderDuplicates(duplicates) {
        if (duplicates.length === 0) {
          duplicatePanel.hidden = true;
          duplicateList.innerHTML = "";
          return;
        }

        duplicatePanel.hidden = false;
        const ul = document.createElement("ul");
        for (const duplicate of duplicates) {
          const li = document.createElement("li");
          li.textContent = `${duplicate.duplicate_rel_path} (kept: ${duplicate.canonical_rel_path})`;
          ul.appendChild(li);
        }
        duplicateList.innerHTML = "";
        duplicateList.appendChild(ul);
      }

      function stageDisplayName(stage) {
        if (!stage) return "Pipeline";
        if (stage === "layout_detect") return "Layout Detection";
        if (stage === "ocr_extract") return "OCR Extraction";
        return stage.replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function renderActivity(activity) {
        const running = activity.in_progress;
        if (running) {
          const pageText = running.rel_path ? ` | ${running.rel_path}` : "";
          pipelineHeadline.textContent = `Running ${stageDisplayName(running.stage)}${pageText}`;
        } else if (activity.worker_running) {
          pipelineHeadline.textContent = "Pipeline worker active";
        } else {
          pipelineHeadline.textContent = "Pipeline worker idle";
        }

        const queueParts = [];
        const queued = activity.queued || { total: 0, by_stage: {} };
        queueParts.push(`Queued jobs: ${queued.total || 0}`);
        if (queued.by_stage && Object.keys(queued.by_stage).length > 0) {
          queueParts.push(
            Object.entries(queued.by_stage)
              .map(([stage, count]) => `${stageDisplayName(stage)}=${count}`)
              .join(", "),
          );
        }
        pipelineQueue.textContent = queueParts.join(" | ");

        const events = activity.recent_events || [];
        pipelineEvents.innerHTML = "";
        if (events.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No backend activity yet.";
          pipelineEvents.appendChild(li);
          return;
        }

        for (const event of events.slice(-10).reverse()) {
          const li = document.createElement("li");
          const ts = formatTime(event.ts);
          const pageText = event.rel_path ? ` (${event.rel_path})` : "";
          const tsSpan = document.createElement("span");
          tsSpan.className = "activity-event-ts";
          tsSpan.textContent = `[${ts}] `;
          li.appendChild(tsSpan);
          li.appendChild(document.createTextNode(`${event.message}${pageText}`));
          pipelineEvents.appendChild(li);
        }
      }

      function applyNextReviewState(payload) {
        if (payload && payload.has_next && Number.isInteger(payload.next_page_id) && payload.next_page_id > 0) {
          nextReviewPageId = payload.next_page_id;
          reviewLayoutsBtn.disabled = false;
          reviewLayoutsBtn.title = payload.next_page_rel_path
            ? `Open next page: ${payload.next_page_rel_path}`
            : "Open next layout review page";
          return;
        }
        nextReviewPageId = null;
        reviewLayoutsBtn.disabled = true;
        reviewLayoutsBtn.title = "No images available for layout review.";
      }

      async function reloadDashboard() {
        const [pagesPayload, duplicatesPayload, activityPayload, nextReviewPayload] = await Promise.all([
          fetchJson("/api/pages"),
          fetchJson("/api/duplicates"),
          fetchJson("/api/pipeline/activity"),
          fetchJson("/api/layout-review/next"),
        ]);

        renderPages(pagesPayload.pages);
        renderDuplicates(duplicatesPayload.duplicates);
        renderActivity(activityPayload);
        applyNextReviewState(nextReviewPayload);
      }

      async function refreshActivityOnly() {
        try {
          const payload = await fetchJson("/api/pipeline/activity");
          renderActivity(payload);
        } catch {
          // Keep existing UI state on transient failures.
        }
      }

      function closeActivityStream() {
        if (activityStream) {
          activityStream.close();
          activityStream = null;
        }
      }

      function scheduleActivityReconnect() {
        if (streamReconnectTimer !== null) {
          return;
        }
        streamReconnectTimer = window.setTimeout(() => {
          streamReconnectTimer = null;
          startActivityStream();
        }, 4000);
      }

      function startActivityStream() {
        closeActivityStream();

        if (!("EventSource" in window)) {
          if (activityPollingTimer === null) {
            activityPollingTimer = window.setInterval(refreshActivityOnly, 3000);
          }
          return;
        }

        activityStream = new EventSource("/api/pipeline/activity/stream?limit=30");
        activityStream.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            renderActivity(payload);
          } catch {
            // Ignore malformed events.
          }
        };
        activityStream.onerror = () => {
          closeActivityStream();
          refreshActivityOnly();
          scheduleActivityReconnect();
        };
      }

      async function runScan({ silent = false } = {}) {
        scanBtn.disabled = true;
        reviewLayoutsBtn.disabled = true;
        wipeBtn.disabled = true;
        if (!silent) {
          lastScan.textContent = "Scanning source folder...";
        }
        try {
          await fetchJson("/api/discovery/scan", { method: "POST" });
          lastScan.textContent = "";
          await reloadDashboard();
        } catch (error) {
          lastScan.textContent = `Scan failed: ${error.message}`;
        } finally {
          scanBtn.disabled = false;
          wipeBtn.disabled = false;
        }
      }

      function openWipeModal() {
        wipeModal.hidden = false;
        wipeConfirmInput.value = "";
        wipeConfirmBtn.disabled = true;
        wipeConfirmInput.focus();
      }

      function closeWipeModal() {
        wipeModal.hidden = true;
        wipeConfirmInput.value = "";
        wipeConfirmBtn.disabled = true;
      }

      async function runWipe() {
        closeWipeModal();
        scanBtn.disabled = true;
        reviewLayoutsBtn.disabled = true;
        wipeBtn.disabled = true;
        lastScan.textContent = "Wiping database state...";

        try {
          const result = await fetchJson("/api/state/wipe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ confirm: true, rescan: true }),
          });

          const deleted = result.deleted_counts;
          const rescan = result.rescan_summary;
          lastScan.textContent =
            `State wiped. Deleted pages: ${deleted.pages}, layouts: ${deleted.layouts}, duplicates: ${deleted.duplicates}. ` +
            `Rescan files: ${rescan ? rescan.scanned_files : 0}, indexed: ${rescan ? rescan.new_pages : 0}, duplicates: ${rescan ? rescan.duplicate_files : 0}. ` +
            `Total Indexed Pages: ${rescan ? rescan.total_pages : 0}, Missing Pages: ${rescan ? rescan.missing_pages : 0}, Active Duplicate Files: ${rescan ? rescan.active_duplicate_files : 0}.`;
          await reloadDashboard();
        } catch (error) {
          lastScan.textContent = `Wipe failed: ${error.message}`;
        } finally {
          scanBtn.disabled = false;
          wipeBtn.disabled = false;
        }
      }

      pipelineToggle.addEventListener("click", () => {
        setPipelinePanelExpanded(!pipelinePanelExpanded);
      });
      scanBtn.addEventListener("click", runScan);
      reviewLayoutsBtn.addEventListener("click", () => {
        if (Number.isInteger(nextReviewPageId) && nextReviewPageId > 0) {
          window.location.href = `/static/layouts.html?page_id=${nextReviewPageId}`;
        }
      });
      wipeBtn.addEventListener("click", openWipeModal);
      wipeCancelBtn.addEventListener("click", closeWipeModal);
      wipeConfirmBtn.addEventListener("click", runWipe);

      wipeConfirmInput.addEventListener("input", () => {
        wipeConfirmBtn.disabled = wipeConfirmInput.value.trim().toLowerCase() !== "wipe";
      });

      wipeModal.addEventListener("click", (event) => {
        if (event.target === wipeModal) {
          closeWipeModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !wipeModal.hidden) {
          closeWipeModal();
        }
      });

      setPipelinePanelExpanded(readStorageBool(STORAGE_KEYS.pipelinePanelExpanded, false));
      reloadDashboard().catch((error) => {
        lastScan.textContent = `Failed to load dashboard: ${error.message}`;
      });
      startActivityStream();
    </script>
  </body>
</html>
