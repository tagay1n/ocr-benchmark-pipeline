<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <style>
      :root {
        --bg: #f3f1eb;
        --surface: #fffdf7;
        --ink: #1e1f1c;
        --muted: #63635f;
        --accent: #0b7a75;
        --danger: #a52222;
        --border: #e0dccf;
        --success: #2f7d32;
        --success-soft: #eaf6eb;
        --sidebar: #17322f;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "IBM Plex Sans", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 100% 0, #d6ebe7 0, transparent 30%),
          radial-gradient(circle at 0 100%, #f7e3cf 0, transparent 32%),
          var(--bg);
      }

      .app-shell {
        min-height: 100vh;
        display: grid;
        grid-template-columns: 280px minmax(0, 1fr);
        transition: grid-template-columns 180ms ease;
      }

      .app-shell.sidebar-collapsed {
        grid-template-columns: 82px minmax(0, 1fr);
      }

      .sidebar {
        background: linear-gradient(180deg, #10312d 0%, #1b4742 100%);
        color: #e9f5f3;
        border-right: 1px solid rgba(255, 255, 255, 0.12);
        padding: 14px 10px;
      }

      .sidebar-top {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .app-shell.sidebar-collapsed .stage-label {
        display: none;
      }

      .sidebar-toggle {
        border: 1px solid rgba(255, 255, 255, 0.24);
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
        border-radius: 8px;
        cursor: pointer;
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        line-height: 1;
        font-weight: 700;
      }

      .stage-tabs {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .stage-tab {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        border: 1px solid rgba(255, 255, 255, 0.16);
        background: rgba(255, 255, 255, 0.08);
        color: #e9f5f3;
        padding: 9px 10px;
        border-radius: 10px;
        cursor: pointer;
        text-align: left;
        font-weight: 600;
      }

      .stage-tab.active {
        border-color: rgba(255, 255, 255, 0.65);
        background: rgba(255, 255, 255, 0.2);
      }

      .stage-tab.done {
        color: var(--success);
        background: var(--success-soft);
        border-color: #98d29b;
        cursor: pointer;
      }

      .stage-count {
        color: inherit;
        font-size: 12px;
        opacity: 0.95;
      }

      .app-shell.sidebar-collapsed .stage-tab {
        justify-content: center;
        padding: 9px 6px;
      }

      .app-shell.sidebar-collapsed .stage-count {
        font-size: 11px;
      }

      main {
        max-width: 1180px;
        width: 100%;
        margin: 0 auto;
        padding: 24px;
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        margin-bottom: 16px;
      }

      h1 {
        margin: 0;
        font-weight: 700;
        font-size: 28px;
      }

      .subline {
        color: var(--muted);
        margin-top: 6px;
      }

      .header-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .stats-actions {
        margin-top: 10px;
        display: flex;
        justify-content: flex-start;
      }

      button {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: white;
        font-weight: 600;
        border-radius: 10px;
        padding: 10px 16px;
        cursor: pointer;
      }

      button.danger-btn {
        border-color: var(--danger);
        background: var(--danger);
      }

      button.secondary {
        background: #fff;
        color: var(--accent);
      }

      button:disabled {
        opacity: 0.6;
        cursor: wait;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        margin-bottom: 16px;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }

      .stat {
        background: #ffffff;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 14px;
      }

      .stat .label {
        font-size: 13px;
        color: var(--muted);
      }

      .stat .value {
        margin-top: 8px;
        font-size: 26px;
        font-weight: 700;
      }

      .danger {
        border-color: #efcece;
        background: #fff5f5;
      }

      .danger strong {
        color: var(--danger);
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th,
      td {
        text-align: left;
        padding: 10px;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      th {
        font-size: 13px;
        color: var(--muted);
      }

      .status {
        border-radius: 999px;
        display: inline-block;
        padding: 4px 10px;
        font-size: 12px;
        font-weight: 700;
        background: #ecf0ef;
      }

      .status.missing {
        color: var(--danger);
        background: #fcebec;
      }

      #stage-heading {
        margin-top: 0;
        margin-bottom: 4px;
      }

      #stage-description {
        color: var(--muted);
        margin-top: 0;
      }

      #last-scan {
        color: var(--muted);
        font-size: 13px;
      }

      .empty-row {
        color: var(--muted);
      }

      .activity-headline {
        margin: 0;
        font-weight: 700;
        text-align: left;
        flex: 1;
      }

      .activity-meta {
        margin: 0;
        color: var(--muted);
        font-size: 13px;
      }

      .panel-toggle {
        width: 100%;
        border: 0;
        background: transparent;
        color: inherit;
        padding: 0;
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
      }

      .panel-toggle-icon {
        width: 22px;
        height: 22px;
        border: 1px solid var(--border);
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: var(--muted);
        font-weight: 700;
      }

      .activity-body {
        margin-top: 10px;
      }

      .activity-list {
        margin: 12px 0 0;
        padding-left: 18px;
      }

      .activity-list li {
        margin: 4px 0;
      }

      .activity-event-ts {
        color: var(--muted);
      }

      .modal-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(18, 23, 25, 0.52);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
        z-index: 20;
      }

      .modal-backdrop[hidden] {
        display: none;
      }

      .modal-card {
        width: min(460px, 100%);
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
      }

      .modal-card h2 {
        margin: 0 0 8px;
      }

      .modal-card p {
        margin: 0 0 12px;
        color: var(--muted);
      }

      .modal-card code {
        background: #ece8df;
        border-radius: 6px;
        padding: 1px 6px;
      }

      .modal-input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 10px;
        font-size: 14px;
      }

      .modal-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }

      @media (max-width: 980px) {
        .app-shell,
        .app-shell.sidebar-collapsed {
          grid-template-columns: 1fr;
        }

        .sidebar {
          border-right: 0;
          border-bottom: 1px solid rgba(255, 255, 255, 0.12);
        }

        .app-shell.sidebar-collapsed .stage-label {
          display: initial;
        }

        .app-shell.sidebar-collapsed .stage-tab {
          justify-content: space-between;
          padding: 9px 10px;
        }

        .header {
          flex-direction: column;
          align-items: flex-start;
        }

        .stats {
          grid-template-columns: 1fr;
        }

        table,
        thead,
        tbody,
        tr,
        th,
        td {
          display: block;
        }

        thead {
          display: none;
        }

        tr {
          border-bottom: 1px solid var(--border);
          padding: 10px 0;
        }

        td {
          border: 0;
          padding: 4px 0;
        }
      }
    </style>
  </head>
  <body>
    <div id="app-shell" class="app-shell">
      <aside class="sidebar">
        <div class="sidebar-top">
          <button id="sidebar-toggle" class="sidebar-toggle" type="button" aria-label="Collapse sidebar">‹</button>
        </div>
        <nav id="stage-tabs" class="stage-tabs" aria-label="Pipeline stage tabs"></nav>
      </aside>

      <main>
        <section class="header">
          <div>
            <h1>Dashboard</h1>
            <div id="source-dir" class="subline"></div>
          </div>
          <div class="header-actions">
            <button id="wipe-btn" class="danger-btn" type="button">Wipe DB State</button>
          </div>
        </section>

        <section id="stats-panel" class="panel">
          <div class="stats">
            <article class="stat">
              <div class="label">Total Indexed Pages</div>
              <div id="stat-total" class="value">0</div>
            </article>
            <article class="stat">
              <div class="label">Missing Pages</div>
              <div id="stat-missing" class="value">0</div>
            </article>
            <article class="stat">
              <div class="label">Active Duplicate Files</div>
              <div id="stat-duplicates" class="value">0</div>
            </article>
          </div>
          <div class="stats-actions">
            <button id="scan-btn" type="button">Scan Input Folder</button>
          </div>
          <p id="last-scan"></p>
        </section>

        <section class="panel">
          <button id="pipeline-toggle" class="panel-toggle" type="button" aria-expanded="false">
            <p id="pipeline-headline" class="activity-headline">Pipeline worker idle</p>
            <span id="pipeline-toggle-icon" class="panel-toggle-icon">+</span>
          </button>
          <div id="pipeline-body" class="activity-body" hidden>
            <p id="pipeline-queue" class="activity-meta"></p>
            <ol id="pipeline-events" class="activity-list"></ol>
          </div>
        </section>

        <section id="duplicate-panel" class="panel danger" hidden>
          <strong>Duplicate files were skipped.</strong>
          <p>
            This warning stays visible on each app start until duplicate files are removed from
            the input folder.
          </p>
          <div id="duplicate-list"></div>
        </section>

        <section class="panel">
          <h2 id="stage-heading">Layout Review (0)</h2>
          <p id="stage-description"></p>
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Relative Path</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Layout Review</th>
              </tr>
            </thead>
            <tbody id="pages-body"></tbody>
          </table>
        </section>
      </main>
    </div>

    <div id="wipe-modal" class="modal-backdrop" hidden>
      <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="wipe-modal-title">
        <h2 id="wipe-modal-title">Confirm DB Wipe</h2>
        <p>Type <code>wipe</code> to delete all indexed pages, layouts, and duplicate state.</p>
        <input
          id="wipe-confirm-input"
          class="modal-input"
          type="text"
          placeholder="Type wipe"
          autocomplete="off"
          spellcheck="false"
        />
        <div class="modal-actions">
          <button id="wipe-cancel-btn" class="secondary" type="button">Cancel</button>
          <button id="wipe-confirm-btn" class="danger-btn" type="button" disabled>Wipe DB State</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { STAGES, filterPagesForStage, getStageById, stageCount } from "/static/js/pipeline_stages.mjs";

      const appShell = document.getElementById("app-shell");
      const sidebarToggle = document.getElementById("sidebar-toggle");
      const stageTabs = document.getElementById("stage-tabs");
      const stageHeading = document.getElementById("stage-heading");
      const stageDescription = document.getElementById("stage-description");

      const scanBtn = document.getElementById("scan-btn");
      const wipeBtn = document.getElementById("wipe-btn");
      const wipeModal = document.getElementById("wipe-modal");
      const wipeConfirmInput = document.getElementById("wipe-confirm-input");
      const wipeCancelBtn = document.getElementById("wipe-cancel-btn");
      const wipeConfirmBtn = document.getElementById("wipe-confirm-btn");

      const sourceDirEl = document.getElementById("source-dir");
      const statTotal = document.getElementById("stat-total");
      const statMissing = document.getElementById("stat-missing");
      const statDuplicates = document.getElementById("stat-duplicates");
      const statsPanel = document.getElementById("stats-panel");
      const pagesBody = document.getElementById("pages-body");
      const duplicatePanel = document.getElementById("duplicate-panel");
      const duplicateList = document.getElementById("duplicate-list");
      const lastScan = document.getElementById("last-scan");
      const pipelineToggle = document.getElementById("pipeline-toggle");
      const pipelineBody = document.getElementById("pipeline-body");
      const pipelineHeadline = document.getElementById("pipeline-headline");
      const pipelineToggleIcon = document.getElementById("pipeline-toggle-icon");
      const pipelineQueue = document.getElementById("pipeline-queue");
      const pipelineEvents = document.getElementById("pipeline-events");

      const queryParams = new URLSearchParams(window.location.search);
      const requestedStageId = queryParams.get("stage");
      const STORAGE_KEYS = {
        selectedStageId: "dashboard.selected_stage_id",
        sidebarCollapsed: "ui.sidebar_collapsed",
        pipelinePanelExpanded: "dashboard.pipeline_panel_expanded",
      };

      function readStorage(key) {
        try {
          return window.localStorage.getItem(key);
        } catch {
          return null;
        }
      }

      function writeStorage(key, value) {
        try {
          window.localStorage.setItem(key, value);
        } catch {
          // Ignore storage errors (private mode / quota / disabled storage).
        }
      }

      function readStorageBool(key, defaultValue) {
        const raw = readStorage(key);
        if (raw === null) {
          return defaultValue;
        }
        return raw === "1";
      }

      function syncStageParam(stageId) {
        const url = new URL(window.location.href);
        url.searchParams.set("stage", stageId);
        window.history.replaceState({}, "", url);
      }

      const storedStageId = readStorage(STORAGE_KEYS.selectedStageId);
      const initialStageId = getStageById(requestedStageId)
        ? requestedStageId
        : getStageById(storedStageId)
          ? storedStageId
          : "layout_review";

      const state = {
        selectedStageId: initialStageId,
        pages: [],
      };
      let pipelinePanelExpanded = false;
      let activityStream = null;
      let streamReconnectTimer = null;
      let activityPollingTimer = null;

      function getSelectedStage() {
        return getStageById(state.selectedStageId) || STAGES[0];
      }

      function updateSidebarToggleState() {
        const isCollapsed = appShell.classList.contains("sidebar-collapsed");
        sidebarToggle.setAttribute("aria-label", isCollapsed ? "Expand sidebar" : "Collapse sidebar");
        sidebarToggle.textContent = isCollapsed ? "›" : "‹";
      }

      function setSidebarCollapsed(collapsed) {
        appShell.classList.toggle("sidebar-collapsed", collapsed);
        writeStorage(STORAGE_KEYS.sidebarCollapsed, collapsed ? "1" : "0");
        updateSidebarToggleState();
      }

      function setPipelinePanelExpanded(expanded) {
        pipelinePanelExpanded = expanded;
        pipelineToggle.setAttribute("aria-expanded", expanded ? "true" : "false");
        pipelineBody.hidden = !expanded;
        pipelineToggleIcon.textContent = expanded ? "−" : "+";
        writeStorage(STORAGE_KEYS.pipelinePanelExpanded, expanded ? "1" : "0");
      }

      async function fetchJson(url, options) {
        const response = await fetch(url, options);
        if (!response.ok) {
          throw new Error(`Request failed: ${response.status}`);
        }
        return response.json();
      }

      function renderStageTabs(pages) {
        stageTabs.innerHTML = "";

        for (const stage of STAGES) {
          const count = stageCount(stage, pages);
          const button = document.createElement("button");
          button.type = "button";
          button.className = "stage-tab";
          if (count === 0) {
            button.classList.add("done");
          }
          if (stage.id === state.selectedStageId) {
            button.classList.add("active");
          }
          button.innerHTML =
            `<span class="stage-label">${stage.name}</span>` + `<span class="stage-count">(${count})</span>`;
          button.title = `${stage.name} (${count})`;
          button.addEventListener("click", () => {
            state.selectedStageId = stage.id;
            writeStorage(STORAGE_KEYS.selectedStageId, stage.id);
            syncStageParam(stage.id);
            renderStageTabs(state.pages);
            renderPages(state.pages);
          });
          stageTabs.appendChild(button);
        }
      }

      function renderPages(pages) {
        const stage = getSelectedStage();
        statsPanel.hidden = stage.id !== "discovery";
        const filteredPages = filterPagesForStage(stage, pages);
        stageHeading.textContent = `${stage.name} (${filteredPages.length})`;
        stageDescription.textContent = stage.description || "";

        pagesBody.innerHTML = "";
        if (filteredPages.length === 0) {
          const tr = document.createElement("tr");
          const emptyText =
            stage.id === "discovery"
              ? "No indexed documents found yet."
              : "No documents have reached this stage yet.";
          tr.innerHTML = `<td class="empty-row" colspan="5">${emptyText}</td>`;
          pagesBody.appendChild(tr);
          return;
        }

        for (const page of filteredPages) {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${page.id}</td>
            <td>${page.rel_path}</td>
            <td>
              <span class="status ${page.is_missing ? "missing" : ""}">
                ${page.is_missing ? "missing" : page.status}
              </span>
            </td>
            <td>${new Date(page.last_seen_at).toLocaleString()}</td>
            <td>
              ${
                page.is_missing
                  ? "<span class=\"subline\">Unavailable</span>"
                  : `<a href="/static/layouts.html?page_id=${page.id}">Open</a>`
              }
            </td>
          `;
          pagesBody.appendChild(tr);
        }
      }

      function renderDuplicates(duplicates) {
        statDuplicates.textContent = duplicates.length;

        if (duplicates.length === 0) {
          duplicatePanel.hidden = true;
          duplicateList.innerHTML = "";
          return;
        }

        duplicatePanel.hidden = false;
        const ul = document.createElement("ul");
        for (const duplicate of duplicates) {
          const li = document.createElement("li");
          li.textContent = `${duplicate.duplicate_rel_path} (kept: ${duplicate.canonical_rel_path})`;
          ul.appendChild(li);
        }
        duplicateList.innerHTML = "";
        duplicateList.appendChild(ul);
      }

      function stageDisplayName(stage) {
        if (!stage) return "Pipeline";
        if (stage === "layout_detect") return "Layout Detection";
        if (stage === "ocr_extract") return "OCR Extraction";
        return stage.replace(/_/g, " ").replace(/\b\w/g, (m) => m.toUpperCase());
      }

      function renderActivity(activity) {
        const running = activity.in_progress;
        if (running) {
          const pageText = running.rel_path ? ` | ${running.rel_path}` : "";
          pipelineHeadline.textContent = `Running ${stageDisplayName(running.stage)}${pageText}`;
        } else if (activity.worker_running) {
          pipelineHeadline.textContent = "Pipeline worker active";
        } else {
          pipelineHeadline.textContent = "Pipeline worker idle";
        }

        const queueParts = [];
        const queued = activity.queued || { total: 0, by_stage: {} };
        queueParts.push(`Queued jobs: ${queued.total || 0}`);
        if (queued.by_stage && Object.keys(queued.by_stage).length > 0) {
          queueParts.push(
            Object.entries(queued.by_stage)
              .map(([stage, count]) => `${stageDisplayName(stage)}=${count}`)
              .join(", "),
          );
        }
        pipelineQueue.textContent = queueParts.join(" | ");

        const events = activity.recent_events || [];
        pipelineEvents.innerHTML = "";
        if (events.length === 0) {
          const li = document.createElement("li");
          li.textContent = "No backend activity yet.";
          pipelineEvents.appendChild(li);
          return;
        }

        for (const event of events.slice(-10).reverse()) {
          const li = document.createElement("li");
          const ts = new Date(event.ts).toLocaleTimeString();
          const pageText = event.rel_path ? ` (${event.rel_path})` : "";
          const tsSpan = document.createElement("span");
          tsSpan.className = "activity-event-ts";
          tsSpan.textContent = `[${ts}] `;
          li.appendChild(tsSpan);
          li.appendChild(document.createTextNode(`${event.message}${pageText}`));
          pipelineEvents.appendChild(li);
        }
      }

      async function reloadDashboard() {
        const [pagesPayload, duplicatesPayload, statsPayload, activityPayload] = await Promise.all([
          fetchJson("/api/pages"),
          fetchJson("/api/duplicates"),
          fetchJson("/api/stats"),
          fetchJson("/api/pipeline/activity"),
        ]);

        sourceDirEl.textContent =
          `Source folder: ${pagesPayload.source_dir} | Formats: ${pagesPayload.allowed_extensions.join(", ")}`;
        statTotal.textContent = statsPayload.total_pages;
        statMissing.textContent = statsPayload.missing_pages;

        state.pages = pagesPayload.pages;
        renderStageTabs(state.pages);
        renderPages(state.pages);
        renderDuplicates(duplicatesPayload.duplicates);
        renderActivity(activityPayload);
      }

      async function refreshActivityOnly() {
        try {
          const activityPayload = await fetchJson("/api/pipeline/activity");
          renderActivity(activityPayload);
        } catch {
          // Keep existing UI state on transient failures.
        }
      }

      function closeActivityStream() {
        if (activityStream) {
          activityStream.close();
          activityStream = null;
        }
      }

      function scheduleActivityReconnect() {
        if (streamReconnectTimer !== null) {
          return;
        }
        streamReconnectTimer = window.setTimeout(() => {
          streamReconnectTimer = null;
          startActivityStream();
        }, 4000);
      }

      function startActivityStream() {
        closeActivityStream();

        if (!("EventSource" in window)) {
          if (activityPollingTimer === null) {
            activityPollingTimer = window.setInterval(refreshActivityOnly, 3000);
          }
          return;
        }

        activityStream = new EventSource("/api/pipeline/activity/stream?limit=30");
        activityStream.onmessage = (event) => {
          try {
            const payload = JSON.parse(event.data);
            renderActivity(payload);
          } catch {
            // Ignore malformed events.
          }
        };
        activityStream.onerror = () => {
          closeActivityStream();
          refreshActivityOnly();
          scheduleActivityReconnect();
        };
      }

      async function runScan({ silent = false } = {}) {
        scanBtn.disabled = true;
        wipeBtn.disabled = true;
        if (!silent) {
          lastScan.textContent = "Scanning source folder...";
        }
        try {
          const scan = await fetchJson("/api/discovery/scan", { method: "POST" });
          lastScan.textContent =
            `Scan finished. Scanned: ${scan.scanned_files}, new: ${scan.new_pages}, updated: ${scan.updated_pages}, ` +
            `missing marked: ${scan.missing_marked}, duplicates: ${scan.duplicate_files}`;
          await reloadDashboard();
        } catch (error) {
          lastScan.textContent = `Scan failed: ${error.message}`;
        } finally {
          scanBtn.disabled = false;
          wipeBtn.disabled = false;
        }
      }

      function openWipeModal() {
        wipeModal.hidden = false;
        wipeConfirmInput.value = "";
        wipeConfirmBtn.disabled = true;
        wipeConfirmInput.focus();
      }

      function closeWipeModal() {
        wipeModal.hidden = true;
        wipeConfirmInput.value = "";
        wipeConfirmBtn.disabled = true;
      }

      async function runWipe() {
        closeWipeModal();
        scanBtn.disabled = true;
        wipeBtn.disabled = true;
        lastScan.textContent = "Wiping database state...";

        try {
          const result = await fetchJson("/api/state/wipe", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ confirm: true, rescan: true }),
          });

          const deleted = result.deleted_counts;
          const rescan = result.rescan_summary;
          lastScan.textContent =
            `State wiped. Deleted pages: ${deleted.pages}, layouts: ${deleted.layouts}, duplicates: ${deleted.duplicates}. ` +
            `Rescan files: ${rescan ? rescan.scanned_files : 0}, indexed: ${rescan ? rescan.new_pages : 0}, duplicates: ${rescan ? rescan.duplicate_files : 0}.`;
          await reloadDashboard();
        } catch (error) {
          lastScan.textContent = `Wipe failed: ${error.message}`;
        } finally {
          scanBtn.disabled = false;
          wipeBtn.disabled = false;
        }
      }

      sidebarToggle.addEventListener("click", () => {
        setSidebarCollapsed(!appShell.classList.contains("sidebar-collapsed"));
      });
      pipelineToggle.addEventListener("click", () => {
        setPipelinePanelExpanded(!pipelinePanelExpanded);
      });
      scanBtn.addEventListener("click", runScan);
      wipeBtn.addEventListener("click", openWipeModal);
      wipeCancelBtn.addEventListener("click", closeWipeModal);
      wipeConfirmBtn.addEventListener("click", runWipe);

      wipeConfirmInput.addEventListener("input", () => {
        wipeConfirmBtn.disabled = wipeConfirmInput.value.trim().toLowerCase() !== "wipe";
      });

      wipeModal.addEventListener("click", (event) => {
        if (event.target === wipeModal) {
          closeWipeModal();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && !wipeModal.hidden) {
          closeWipeModal();
        }
      });

      writeStorage(STORAGE_KEYS.selectedStageId, state.selectedStageId);
      syncStageParam(state.selectedStageId);
      setSidebarCollapsed(readStorageBool(STORAGE_KEYS.sidebarCollapsed, false));
      setPipelinePanelExpanded(readStorageBool(STORAGE_KEYS.pipelinePanelExpanded, false));
      runScan({ silent: true }).catch((error) => {
        lastScan.textContent = `Failed to scan dashboard on startup: ${error.message}`;
      });
      startActivityStream();
    </script>
  </body>
</html>
